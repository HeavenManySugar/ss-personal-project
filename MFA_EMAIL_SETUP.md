# MFA Email Verification Setup Guide

## ğŸ“§ åŠŸèƒ½èªªæ˜

ç‚º MFA é›™å› ç´ é©—è­‰æ–°å¢**é›»å­éƒµä»¶é©—è­‰**é¸é …,ä½œç‚º TOTP (Google Authenticator) çš„æ›¿ä»£æ–¹æ¡ˆã€‚

### ä½¿ç”¨å ´æ™¯
- ç”¨æˆ¶æ²’æœ‰ Authenticator App
- æ‰‹æ©Ÿç„¡æ³•ä½¿ç”¨æ™‚çš„å‚™ç”¨æ–¹æ¡ˆ
- æ›´å‹å–„çš„ç”¨æˆ¶é«”é©—

## ğŸš€ è¨­ç½®æ­¥é©Ÿ

### 1. æ›´æ–°è³‡æ–™åº« Schema

åŸ·è¡Œä»¥ä¸‹å‘½ä»¤ä¾†æ–°å¢ MFA é›»å­éƒµä»¶ tokens è¡¨:

```bash
# æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
npx wrangler d1 execute auth_system --file=./mfa-email-schema.sql --local

# ç”Ÿç”¢ç’°å¢ƒ
npx wrangler d1 execute auth_system --file=./mfa-email-schema.sql --remote
```

### 2. ç¢ºèª Resend API å·²è¨­å®š

MFA éƒµä»¶ä½¿ç”¨èˆ‡è¨»å†Šé©—è­‰ç›¸åŒçš„ Resend é…ç½®:

```bash
# ç¢ºèª secrets å·²è¨­å®š
npx wrangler secret list

# æ‡‰è©²çœ‹åˆ°:
# - RESEND_API_KEY
# - FROM_EMAIL
```

å¦‚æœå°šæœªè¨­å®š,è«‹åƒè€ƒ `EMAIL_VERIFICATION_SETUP.md`ã€‚

### 3. æ¸¬è©¦åŠŸèƒ½

```bash
npm run dev
```

1. ç™»å…¥å•Ÿç”¨ MFA çš„å¸³è™Ÿ
2. åœ¨ MFA é©—è­‰é é¢é»æ“Šã€Œsend code to emailã€
3. æª¢æŸ¥ä¿¡ç®±ä¸¦è¼¸å…¥æ”¶åˆ°çš„ 6 ä½æ•¸é©—è­‰ç¢¼

## ğŸ“‹ å·¥ä½œæµç¨‹

```
ç™»å…¥ (å¯†ç¢¼é©—è­‰) 
    â†“
MFA é©—è­‰é é¢
    â†“
ç”¨æˆ¶é¸æ“‡é©—è­‰æ–¹å¼:
    â”œâ”€ é¸é … 1: ä½¿ç”¨ Authenticator App (TOTP)
    â””â”€ é¸é … 2: æ¥æ”¶éƒµä»¶é©—è­‰ç¢¼ â† æ–°åŠŸèƒ½!
         â†“
    ç³»çµ±ç™¼é€ 6 ä½æ•¸é©—è­‰ç¢¼åˆ°è¨»å†Šä¿¡ç®±
         â†“
    ç”¨æˆ¶è¼¸å…¥é©—è­‰ç¢¼
         â†“
    é©—è­‰æˆåŠŸ â†’ ç™»å…¥å®Œæˆ
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- âœ… **é©—è­‰ç¢¼éš¨æ©Ÿç”Ÿæˆ**: 6 ä½æ•¸ç´”æ•¸å­—
- âœ… **æœ‰æ•ˆæœŸé™åˆ¶**: 10 åˆ†é˜å¾ŒéæœŸ
- âœ… **å–®æ¬¡ä½¿ç”¨**: é©—è­‰å¾Œç«‹å³å¤±æ•ˆ
- âœ… **é »ç‡é™åˆ¶**: æ¯ 2 åˆ†é˜åªèƒ½ç™¼é€ä¸€æ¬¡
- âœ… **é›™é‡é©—è­‰æ”¯æ´**: 
  - å„ªå…ˆæª¢æŸ¥éƒµä»¶é©—è­‰ç¢¼
  - å¤±æ•—å¾Œæª¢æŸ¥ TOTP ç¢¼
  - å…©ç¨®æ–¹å¼éƒ½æ”¯æ´

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æª”æ¡ˆ

### æ–°å¢æª”æ¡ˆ:
- `src/pages/api/auth/send-mfa-email.ts` - ç™¼é€ MFA éƒµä»¶é©—è­‰ç¢¼ API
- `mfa-email-schema.sql` - MFA éƒµä»¶ tokens è³‡æ–™è¡¨

### ä¿®æ”¹æª”æ¡ˆ:
- `src/pages/api/auth/verify-mfa.ts` - æ”¯æ´éƒµä»¶é©—è­‰ç¢¼é©—è­‰
- `src/pages/verify-mfa.astro` - æ–°å¢ã€Œç™¼é€éƒµä»¶é©—è­‰ç¢¼ã€æŒ‰éˆ•

## ğŸ¨ ä½¿ç”¨è€…ä»‹é¢

MFA é©—è­‰é é¢ç¾åœ¨é¡¯ç¤º:

```
ğŸ” Two-Factor Authentication

Enter the 6-digit code from your authenticator app.
Or send code to email  â† é»æ“Šç™¼é€éƒµä»¶

Authentication Code: [______]

[Verify]
```

## ğŸ”§ é…ç½®é¸é …

### èª¿æ•´é©—è­‰ç¢¼æœ‰æ•ˆæœŸ

åœ¨ `send-mfa-email.ts` ä¸­ä¿®æ”¹:

```typescript
// é è¨­ 10 åˆ†é˜
const expiresAt = new Date(Date.now() + 10 * 60 * 1000).toISOString();

// æ”¹ç‚º 5 åˆ†é˜
const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();
```

### èª¿æ•´ç™¼é€é »ç‡é™åˆ¶

åœ¨ `send-mfa-email.ts` ä¸­ä¿®æ”¹:

```typescript
// é è¨­ 2 åˆ†é˜
if (minutesSinceLastSend < 2) {

// æ”¹ç‚º 3 åˆ†é˜
if (minutesSinceLastSend < 3) {
```

### è‡ªè¨‚éƒµä»¶æ¨¡æ¿

åœ¨ `send-mfa-email.ts` çš„ `emailHtml` å’Œ `emailText` è®Šæ•¸ä¸­ä¿®æ”¹éƒµä»¶å…§å®¹å’Œæ¨£å¼ã€‚

## â“ å¸¸è¦‹å•é¡Œ

### Q: éƒµä»¶å’Œ TOTP å“ªå€‹å„ªå…ˆ?
A: ç³»çµ±æœƒå…ˆæª¢æŸ¥éƒµä»¶é©—è­‰ç¢¼,å¦‚æœä¸åŒ¹é…å‰‡æª¢æŸ¥ TOTPã€‚å…©è€…éƒ½æœ‰æ•ˆã€‚

### Q: å¯ä»¥åªç”¨éƒµä»¶é©—è­‰å—?
A: å¯ä»¥ã€‚å³ä½¿æ²’æœ‰è¨­å®š Authenticator App (mfa_secret ç‚º null),åªè¦ mfa_enabled = 1,å°±èƒ½ä½¿ç”¨éƒµä»¶é©—è­‰ã€‚

### Q: éƒµä»¶é©—è­‰ç¢¼æœƒéæœŸå—?
A: æœƒ,é è¨­ 10 åˆ†é˜å¾ŒéæœŸã€‚

### Q: å¯ä»¥é‡æ–°ç™¼é€å—?
A: å¯ä»¥,ä½†æ¯ 2 åˆ†é˜åªèƒ½ç™¼é€ä¸€æ¬¡ã€‚

### Q: éƒµä»¶ç™¼é€å¤±æ•—æ€éº¼è¾¦?
A: å¯ä»¥ç¹¼çºŒä½¿ç”¨ Authenticator App çš„ TOTP ç¢¼,æˆ–ç­‰å¾… 2 åˆ†é˜å¾Œé‡è©¦ç™¼é€éƒµä»¶ã€‚

## ğŸ§¹ æ¸…ç†éæœŸ Tokens

å®šæœŸæ¸…ç†éæœŸçš„ MFA éƒµä»¶ tokens:

```sql
-- åˆªé™¤ 1 å¤©å‰éæœŸçš„ tokens
DELETE FROM mfa_email_tokens 
WHERE expires_at < datetime('now', '-1 day');
```

å¯ä»¥åŠ å…¥åˆ° `cleanup-unverified.sql` æˆ–å®šæœŸ cron job ä¸­åŸ·è¡Œã€‚

## ğŸ¯ ç”Ÿç”¢ç’°å¢ƒæª¢æŸ¥æ¸…å–®

- [ ] è³‡æ–™åº« schema å·²æ›´æ–°
- [ ] Resend API Key å·²è¨­å®š
- [ ] FROM_EMAIL å·²é…ç½®
- [ ] æ¸¬è©¦ç™¼é€ MFA éƒµä»¶
- [ ] æ¸¬è©¦é©—è­‰æµç¨‹
- [ ] æª¢æŸ¥éƒµä»¶é€é”ç‡
- [ ] è¨­å®šå®šæœŸæ¸…ç†ä»»å‹™
- [ ] ç›£æ§ç™¼é€é »ç‡å’ŒéŒ¯èª¤

## ğŸ“ˆ ç›£æ§å»ºè­°

è¿½è¹¤ä»¥ä¸‹æŒ‡æ¨™:
- MFA éƒµä»¶ç™¼é€æˆåŠŸç‡
- é©—è­‰ç¢¼é©—è­‰æˆåŠŸç‡
- å¹³å‡é©—è­‰æ™‚é–“
- TOTP vs éƒµä»¶é©—è­‰ä½¿ç”¨æ¯”ä¾‹
